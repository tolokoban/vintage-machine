require("basic",function(t,e){function s(){return x(m,arguments)}function a(t){this._id=0,this.clear(),"undefined"==typeof t&&(t=""),this._code=t;for(var e=new v(t);e.hasMoreCode();)n.call(this,e,"instruction","affectation")||e.hasMoreCode()&&!e.next("EOL")&&e.fatal("Caractère inattendu ! Je suis perdu...");this._asm.forEach(function(t,e,s){Array.isArray(t)&&(s[e]=this._labels[t[0]])},this)}function n(t){var e,s;for(e=1;e<arguments.length;e++){if(s=d[arguments[e].toLowerCase()],!s)throw Error('Unknonw parser: "'+arguments[e]+'"!');if(s.call(this,t))return!0}return!1}function r(t){t=t.substr(1).toUpperCase();for(var e="0123456789ABCDEF",s=0,a=0;a<t.length;a++)s=(s<<4)+e.indexOf(t.charAt(a));return this._asm.push(s),!0}function i(t){var e=t.next("VAR");e||t.fatal(s("missing-var-after-for"));var a=e.val;if(e=t.next("EQUAL","IN","COMMA"),e||t.fatal(s("missing-for-equal-or-to")),","==e.val){e=t.next("VAR"),e||t.fatal(s("missing-var-index-foreach",a));var r=e.val;return t.next("IN")||t.fatal(s("missing-foreach-in")),l.call(this,t,a,r)}if("IN"==e.val)return l.call(this,t,a);var i=this.newLabel(),u=this.newLabel();return this._asm.push(a,E.ERASE),this.setLabel(i),this._context.push({type:"FOR",labelA:i,labelB:u}),this._asm.push(a),n.call(this,t,"expression")||t.fatal(s("missing-expression")),t.next("TO")||t.fatal(s("missing-to")),n.call(this,t,"expression")||t.fatal(s("missing-expression")),t.next("STEP")?n.call(this,t,"expression")||t.fatal(s("missing-expression")):this._asm.push(1),t.next("EOL")||t.fatal(s("expected-eol")),this._asm.push([u],E.FOR),!0}function l(t,e,a){"undefined"==typeof a&&(a="tmp"+this.nextID());var n=t.next("VAR");n||t.fatal(s("missing-list-foreach"));var r=n.val,i=this.newLabel(),l=this.newLabel();return this._asm.push(a,E.ERASE),this.setLabel(i),this._context.push({type:"FOR",labelA:i,labelB:l}),this._asm.push(e,a,r,[l],E.FORE),!0}function u(t){var e=this._context.pop();return e||t.fatal(s("unexpected-next")),"FOR"==e.type?(this._asm.push([e.labelA],E.JMP),this.setLabel(e.labelB)):t.fatal(s("unexpected-next")),!0}function o(t){n.call(this,t,"expression")||t.fatal(s("print-missing-arg")),this._asm.push("print.txt",E.SET),t.next("COMMA")?(n.call(this,t,"expression")||t.fatal(s("print-missing-arg")),this._asm.push("print.frm",E.SET)):this._asm.push(0,"print.frm",E.SET),t.next("EOL")||t.fatal(s("expected-eol"));var e=this.newLabel(),a=this.newLabel();return this.setLabel(e),this._asm.push("print.txt",E.GET,E.LEN,[a],E.JZE),this._asm.push("print.txt",E.SHIFT,E.ASC,E.PRINTCHAR),this._asm.push("print.frm",E.GET,E.FRAME),this._asm.push([e],E.JMP),this.setLabel(a),!0}function c(t,e,a){"function"!=typeof E[e]&&t.fatal(s("unknown-function",e));for(var r,i=0;n.call(this,t,"expression")&&(i++,r=t.next("COMMA","PAR_CLOSE","EOL"),r||t.fatal(s("missing-par-close")),"COMMA"==r.id););return 0==i&&(t.next("PAR_CLOSE")||t.fatal(s("missing-par-close"))),"number"==typeof a?a!=i&&t.fatal(s("fixed-args",e,a,i)):this._asm.push(i),this._asm.push(E[e]),!0}function h(t,e){"function"!=typeof E[e]&&t.fatal(s("unknown-instr",e));for(var a,r=0;n.call(this,t,"expression")&&(r++,a=t.next("COMMA","EOL"),a||t.fatal(s("unexpected-token")),"COMMA"==a.id););return this._asm.push(r,E[e]),!0}function p(t,e,a){var r=arguments.length-3;if(a+r>0){var i,l;for(i=0;i<a+r&&(l=!1,i>0&&(l=!t.next("COMMA")),n.call(this,t,"expression"));i++)l&&t.fatal(s("mising-comma"));i<a&&t.fatal(s("too-few-args",e,a)+"\n"+s(e.toLowerCase()));var u,o=i-a;for(i=o;i<r;i++)u=arguments[3+i],Array.isArray(u)?this._asm.push.apply(this._asm,u):this._asm.push(u);t.next("EOL")||t.fatal(s("too-many-args",a,a+r)+"\n"+s("instr-"+e))}return this._asm.push(E[e]),!0}function f(t){t=t.substr(1,t.length-2);for(var e,s="",a=0,n=0,r=0;r<t.length;r++)e=t.charAt(r),0==n?"\\"==e&&(s+=t.substr(a),n=1):(s+="n"==e?"\n":"t"==e?"\t":e,a=r+1,n=1);return s+=t.substr(a)}var m={fr:{"expected-eol":"L'instruction devrait s'arrêter là.","fixed-args":"$1 attend exactement $2 argument(s) et pas $3.","missing-comma":"Il faut séparer les arguments par des virgules.","missing-equal":"Après un nom de variable, il faut mettre un '='.","missing-expression":"J'ai besoin d'une expression : c'est-à-dire un nombre, une chaîne de caractères, une variable, un calcul...","missing-expression-after":'Il me faut une expression après "$1".',"missing-for-equal-or-to":"Après le nom de variable, il me faut un égal ou IN.","missing-par-close":"Il manque une paranthèse fermante !","missing-to":"Il faut le mot clef TO dans un FOR pour que ça fonctionne.","missing-var-after-for":"Il faut un nom de variable juste après FOR.","missing-var-index-foreach":"Après la virgule, il me faut la variable qui contiendra l'index du caractère $1.","print-missing-arg":"L'instruction PRINT attend le texte à afficher comme argument.","too-few-args":"L'instruction \"$1\" a besoin d'au moins $2 argument(s).","too-many-args":"Cette instruction attend au minimum $1 argument(s), et au maximum $2.","unexpected-token":"Il y a là un caractère que je ne comprends pas.","unexpected-next":"Ce NEXT ne correspond à aucun FOR.","unknown-function":"Je ne connais aucune fonction appelée $1.","unknown-instr":"Cette instruction m'est inconnue : $1."},en:{}},x=require("$").intl,E=require("asm"),v=require("lexer"),A={and:E.AND,or:E.OR,xor:E.XOR,">=":E.GEQ,"<=":E.LEQ,"<>":E.NEQ,"^":E.EXP,"=":E.EQ,"%":E.MOD,"+":E.ADD,"*":E.MUL,"/":E.DIV,"-":E.SUB,"<":E.LT,">":E.GT},_={NL:"\n",PI:Math.PI},g={ABS:1,ASC:1,COS:1,IIF:3,LEN:1,NEG:1,SHIFT:1,SIN:1,WAIT:0};a.prototype.nextID=function(){return this._id++},a.prototype.asm=function(){return this._asm.slice()},a.prototype.clear=function(){this._code="",this._asm=[],this._labels={},this._labelId=0,this._context=[]},a.prototype.newLabel=function(){return this._labelId++},a.prototype.setLabel=function(t){this._labels[t]=this._asm.length};var d={instruction:function(t){var e=t.next("INST");if(!e)return!1;var a=e.val.toUpperCase();switch(a){case"LOCATE":return p.call(this,t,"LOCATE",2);case"SPRITE":return p.call(this,t,"SPRITE",1,1,1);case"MOVE":return p.call(this,t,"MOVE",0,320,240);case"MOVER":return p.call(this,t,"MOVER",0,16,0);case"FRAME":return p.call(this,t,"FRAME",0,1);case"POINT":return p.call(this,t,"POINT",2,["color",E.GET]);case"TRIS":return p.call(this,t,"TRIS",0);case"TRIANGLE":return p.call(this,t,"TRIANGLE",0,0,0,320,480,640,0);case"DISK":return h.call(this,t,"DISK");case"BOX":return h.call(this,t,"BOX");case"CLS":return h.call(this,t,"CLS");case"PEN":return h.call(this,t,"PEN");case"PAPER":return p.call(this,t,"PAPER",0,61440);case"FOR":return i.call(this,t);case"NEXT":return u.call(this,t);case"INK":return p.call(this,t,"INK",3,-1);case"PRINT":return o.call(this,t,"PRINT");case"SPEAK":return p.call(this,t,"SPEAK",0,"Je suis TLK-74.");case"BACK":return p.call(this,t,"BACK",0,7,0);case"DEBUGGER":return p.call(this,t,"DEBUGGER",0)}return t.fatal(s("unknown-instr",e.val.toUpperCase())),!1},affectation:function(t){var e=t.next("VAR");if(!e)return!1;var a=e.val;return t.next("EQUAL")||t.fatal(s("missing-equal")),n.call(this,t,"expression")||t.fatal(s("missing-expression")),this._asm.push(a,E.SET),!0},expression:function(t){if(!n.call(this,t,"atom"))return!1;var e=t.next("BINOP");return e&&(n.call(this,t,"expression")||t.fatal(s("missing-expression-after",e.val)),this._asm.push(A[e.val])),!0},atom:function(t){var e=t.next("FUNC","NUM","HEX","STR","VAR","PAR_OPEN","CONST");if(e)switch(e.id){case"NUM":return this._asm.push(parseFloat(e.val)),!0;case"HEX":return r.call(this,e.val);case"STR":return this._asm.push(f(e.val)),!0;case"VAR":return this._asm.push(e.val,E.GET),!0;case"CONST":var a=_[e.val.toUpperCase()];return a||t.fatal(s("unknown-const",e.val)),Array.isArray(a)?this._asm.push.apply(this._asm,a):this._asm.push(a),!0;case"FUNC":var i=e.val.substr(0,e.val.length-1).toUpperCase(),l=c.call(this,t,i,g[i]);return!!l;case"PAR_OPEN":return n.call(this,t,"expression"),e=t.next("PAR_CLOSE"),e||t.fatal(s("missing-par-close")),!0}return!1}};e.exports=a,e.exports._=s});
//# sourceMappingURL=basic.js.map